$ErrorActionPreference = "Stop"

function WriteUtf8NoBom([string]$Path, [string]$Content) {
  $dir = Split-Path -Parent $Path
  if ($dir -and !(Test-Path $dir)) { New-Item -ItemType Directory -Force -Path $dir | Out-Null }
  $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
  [System.IO.File]::WriteAllText($Path, $Content, $utf8NoBom)
}

$ROOT   = "C:\Users\Luyanda\dc-emergency-web"
$CLIENT = Join-Path $ROOT "client"
$SRC    = Join-Path $CLIENT "src"

if (!(Test-Path $CLIENT)) { throw "Missing client folder: $CLIENT" }

Write-Host "Applying Phase B UI..." -ForegroundColor Cyan
Write-Host "Root:   $ROOT" -ForegroundColor DarkGray
Write-Host "Client: $CLIENT" -ForegroundColor DarkGray

New-Item -ItemType Directory -Force -Path (Join-Path $SRC "pages") | Out-Null
New-Item -ItemType Directory -Force -Path (Join-Path $SRC "components") | Out-Null
New-Item -ItemType Directory -Force -Path (Join-Path $SRC "services") | Out-Null

# 1) BULLETPROOF api.js: supports default export, named { api }, and { setAuthToken }
$apiJsPath = Join-Path $SRC "services\api.js"
$apiJs = @'
import axios from "axios";

const baseURL =
  import.meta.env.VITE_API_BASE ||
  "http://localhost:5000/api";

const api = axios.create({
  baseURL,
  withCredentials: false,
});

export function setAuthToken(token) {
  if (token) {
    api.defaults.headers.common["Authorization"] = `Bearer ${token}`;
  } else {
    delete api.defaults.headers.common["Authorization"];
  }
}

// Optional: attach token from storage if present
try {
  const t = localStorage.getItem("dc_token");
  if (t) setAuthToken(t);
} catch {}

export { api };
export default api;
'@
WriteUtf8NoBom $apiJsPath $apiJs
Write-Host "Wrote: src/services/api.js (default + named exports)" -ForegroundColor Green

# 2) Community page - Instagram-like feed cards + Province/National toggle
$communityPath = Join-Path $SRC "pages\Community.jsx"
$community = @'
import React, { useEffect, useMemo, useState } from "react";
import api from "../services/api";

function ScopeToggle({ scope, setScope }) {
  return (
    <div className="card p-2 flex gap-2">
      <button
        className={"btn flex-1 " + (scope === "national" ? "btn-primary" : "")}
        onClick={() => setScope("national")}
      >
        National
      </button>
      <button
        className={"btn flex-1 " + (scope === "province" ? "btn-primary" : "")}
        onClick={() => setScope("province")}
      >
        Province
      </button>
    </div>
  );
}

function ProvinceSelect({ province, setProvince }) {
  const provinces = useMemo(() => ([
    "Gauteng","KwaZulu-Natal","Western Cape","Eastern Cape","Free State",
    "Limpopo","Mpumalanga","North West","Northern Cape"
  ]), []);

  return (
    <select className="input" value={province} onChange={(e) => setProvince(e.target.value)}>
      {provinces.map((p) => <option key={p} value={p}>{p}</option>)}
    </select>
  );
}

function Avatar({ seed }) {
  // simple deterministic fallback avatar (no external images needed)
  const letter = (seed || "U").trim().charAt(0).toUpperCase();
  return (
    <div className="h-10 w-10 rounded-2xl bg-white/10 border border-white/10 flex items-center justify-center">
      <span className="font-semibold">{letter}</span>
    </div>
  );
}

function PostCard({ post }) {
  return (
    <div className="card p-4">
      <div className="flex items-start justify-between gap-3">
        <div className="flex items-center gap-3">
          <Avatar seed={post.author} />
          <div>
            <div className="text-sm font-semibold leading-tight">{post.author}</div>
            <div className="text-[11px] text-white/60 leading-tight">{post.location}</div>
          </div>
        </div>
        <div className="chip">{post.tag}</div>
      </div>

      <div className="mt-3 text-sm text-white/90 leading-relaxed">
        {post.text}
      </div>

      <div className="mt-4 flex items-center justify-between">
        <div className="flex gap-2">
          <button className="btn">Support</button>
          <button className="btn">Comment</button>
        </div>
        <div className="text-xs text-white/60">{post.time}</div>
      </div>
    </div>
  );
}

export default function Community() {
  const [scope, setScope] = useState("national");
  const [province, setProvince] = useState("Gauteng");
  const [loading, setLoading] = useState(false);
  const [posts, setPosts] = useState([]);

  const fallback = useMemo(() => ([
    {
      id: "1",
      author: "DC Community",
      location: "South Africa",
      tag: "Update",
      text: "Welcome to the community feed. Once the backend routes are stable, live posts will appear here.",
      time: "Just now",
    },
    {
      id: "2",
      author: "Safety Tip",
      location: province,
      tag: "Tip",
      text: "If you feel unsafe, press SOS. Keep emergency contacts updated in Profile.",
      time: "Today",
    },
  ]), [province]);

  async function loadFeed() {
    setLoading(true);
    try {
      // If your backend has a community route later, plug it in here.
      // For now, attempt hotspots stories (some builds used it), but never crash UI.
      const url =
        scope === "national"
          ? "/hotspots/stories"
          : `/hotspots/stories?province=${encodeURIComponent(province)}`;

      const res = await api.get(url);
      const arr = Array.isArray(res.data) ? res.data : (res.data?.items || []);
      if (arr && arr.length) {
        const normalized = arr.map((x, i) => ({
          id: String(x._id || i),
          author: x.author || "Anonymous",
          location: x.province || province,
          tag: x.tag || "Story",
          text: x.text || x.content || "Post",
          time: x.createdAt ? new Date(x.createdAt).toLocaleString() : "Recently",
        }));
        setPosts(normalized);
      } else {
        setPosts(fallback);
      }
    } catch {
      setPosts(fallback);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    loadFeed();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [scope, province]);

  return (
    <div className="space-y-4">
      <div className="card p-4">
        <div className="flex items-start justify-between gap-3">
          <div>
            <div className="title">Community</div>
            <div className="muted text-sm">National + province-based updates, support, and alerts.</div>
          </div>
          <a className="chip" href="/profile">Profile</a>
        </div>

        <div className="mt-4 grid gap-3">
          <ScopeToggle scope={scope} setScope={setScope} />
          {scope === "province" && <ProvinceSelect province={province} setProvince={setProvince} />}

          <div className="flex gap-2">
            <button className="btn flex-1" onClick={loadFeed}>
              {loading ? "Refreshing..." : "Refresh"}
            </button>
            <button
              className="btn flex-1 btn-primary"
              onClick={() => alert("Post composer is Phase C (next).")}
            >
              Create Post
            </button>
          </div>
        </div>
      </div>

      <div className="space-y-3">
        {posts.map((p) => <PostCard key={p.id} post={p} />)}
      </div>
    </div>
  );
}
'@
WriteUtf8NoBom $communityPath $community
Write-Host "Wrote: src/pages/Community.jsx" -ForegroundColor Green

# 3) Risk page - no sliders; clean step cards + result
$riskPath = Join-Path $SRC "pages\Risk.jsx"
$risk = @'
import React, { useMemo, useState } from "react";
import api from "../services/api";

const QUESTIONS = [
  { id: "q1", text: "Do you feel unsafe at home or in your relationship?", weight: 3 },
  { id: "q2", text: "Has anyone threatened you, stalked you, or controlled your movements?", weight: 3 },
  { id: "q3", text: "Have you experienced physical harm recently?", weight: 4 },
  { id: "q4", text: "Do you have access to a safe place or trusted support nearby?", weight: 2, invert: true },
  { id: "q5", text: "Are children involved or at risk?", weight: 3 },
];

function scoreAnswers(a) {
  let total = 0;
  for (const q of QUESTIONS) {
    const val = a[q.id] ?? "unsure";
    // yes=2, unsure=1, no=0 (invert flips)
    let s = val === "yes" ? 2 : val === "unsure" ? 1 : 0;
    if (q.invert) s = 2 - s;
    total += s * q.weight;
  }
  return total;
}

function band(total) {
  if (total >= 20) return { level: "High", color: "bg-red-600", text: "High risk. Consider immediate support and safety planning." };
  if (total >= 12) return { level: "Medium", color: "bg-yellow-500", text: "Medium risk. Take precautions and reach out to support." };
  return { level: "Low", color: "bg-green-600", text: "Lower risk detected. Stay aware and keep resources handy." };
}

function Choice({ value, setValue }) {
  return (
    <div className="grid grid-cols-3 gap-2">
      <button className={"btn " + (value==="yes" ? "btn-primary" : "")} onClick={() => setValue("yes")}>Yes</button>
      <button className={"btn " + (value==="unsure" ? "btn-primary" : "")} onClick={() => setValue("unsure")}>Unsure</button>
      <button className={"btn " + (value==="no" ? "btn-primary" : "")} onClick={() => setValue("no")}>No</button>
    </div>
  );
}

export default function Risk() {
  const [answers, setAnswers] = useState({});
  const total = useMemo(() => scoreAnswers(answers), [answers]);
  const b = useMemo(() => band(total), [total]);

  async function saveRisk() {
    try {
      await api.post("/risk", { answers, total, level: b.level });
      alert("Saved.");
    } catch {
      alert("Saved locally (backend route not ready).");
    }
  }

  return (
    <div className="space-y-4">
      <div className="card p-4">
        <div className="flex items-start justify-between gap-3">
          <div>
            <div className="title">Risk Assessment</div>
            <div className="muted text-sm">Clean, quick check-in. No sliders. Private by default.</div>
          </div>
          <a className="chip" href="/">SOS</a>
        </div>

        <div className="mt-4 space-y-3">
          {QUESTIONS.map((q) => (
            <div key={q.id} className="p-3 rounded-2xl bg-white/5 border border-white/10">
              <div className="text-sm font-semibold">{q.text}</div>
              <div className="mt-2">
                <Choice
                  value={answers[q.id] ?? "unsure"}
                  setValue={(v) => setAnswers((prev) => ({ ...prev, [q.id]: v }))}
                />
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="card p-4">
        <div className="flex items-center justify-between">
          <div>
            <div className="title">Result</div>
            <div className="muted text-sm">{b.text}</div>
          </div>
          <div className={"chip " + b.color}>{b.level}</div>
        </div>

        <div className="mt-4 grid grid-cols-2 gap-3">
          <button className="btn btn-primary" onClick={() => alert("Phase C: AI Therapist + Live Agent flow")}>
            Get Help Now
          </button>
          <button className="btn" onClick={saveRisk}>
            Save
          </button>
        </div>

        <div className="mt-3 text-xs text-white/60">
          If you are in immediate danger, use SOS or contact local emergency services.
        </div>
      </div>
    </div>
  );
}
'@
WriteUtf8NoBom $riskPath $risk
Write-Host "Wrote: src/pages/Risk.jsx" -ForegroundColor Green

Write-Host ""
Write-Host "Phase B applied." -ForegroundColor Green
Write-Host "Now do this:" -ForegroundColor Cyan
Write-Host "1) Close Vite terminal (Ctrl+C)" -ForegroundColor Cyan
Write-Host "2) cd $CLIENT" -ForegroundColor Cyan
Write-Host "3) Remove-Item -Recurse -Force .\node_modules\.vite -ErrorAction SilentlyContinue" -ForegroundColor Cyan
Write-Host "4) npm run dev" -ForegroundColor Cyan
Write-Host "5) Open: http://localhost:5173/community and /risk" -ForegroundColor Cyan
