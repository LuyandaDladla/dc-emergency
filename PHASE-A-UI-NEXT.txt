$ErrorActionPreference = "Stop"

function Say($m){ Write-Host $m -ForegroundColor Cyan }
function Ok($m){ Write-Host $m -ForegroundColor Green }
function Warn($m){ Write-Host $m -ForegroundColor Yellow }

function WriteUtf8NoBom([string]$Path, [string]$Content) {
  $dir = Split-Path -Parent $Path
  if ($dir -and !(Test-Path $dir)) { New-Item -ItemType Directory -Path $dir | Out-Null }
  $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
  [System.IO.File]::WriteAllText($Path, $Content, $utf8NoBom)
}

$ROOT = (Get-Location).Path
$CLIENT = Join-Path $ROOT "client"
if (!(Test-Path $CLIENT)) { throw "client folder not found. Run from repo root." }

Say "Applying NEXT UI STEP (AppShell + Instagram-like bottom nav + big SOS)..."
Say ("Root: " + $ROOT)

# Paths
$appShellPath = Join-Path $CLIENT "src\components\AppShell.jsx"
$bottomNavPath = Join-Path $CLIENT "src\components\BottomNav.jsx"
$uiPath = Join-Path $CLIENT "src\components\ui\GlowCard.jsx"

# Ensure folders
New-Item -ItemType Directory -Force (Split-Path -Parent $appShellPath) | Out-Null
New-Item -ItemType Directory -Force (Split-Path -Parent $bottomNavPath) | Out-Null
New-Item -ItemType Directory -Force (Split-Path -Parent $uiPath) | Out-Null

# --- GlowCard (tiny helper, makes UI feel premium) ---
$glowCard = @'
export default function GlowCard({ children, className = "" }) {
  return (
    <div
      className={[
        "rounded-2xl border border-white/10 bg-white/[0.04] shadow-[0_0_0_1px_rgba(255,255,255,0.03)]",
        "backdrop-blur-xl",
        className,
      ].join(" ")}
    >
      {children}
    </div>
  );
}
'@
WriteUtf8NoBom $uiPath $glowCard

# --- BottomNav ---
$bottomNav = @'
import { NavLink, useLocation, useNavigate } from "react-router-dom";
import { useMemo } from "react";
import { useAuth } from "../context/AuthContext";

// Simple inline icons (no extra deps)
function Icon({ children }) {
  return <span className="text-[22px] leading-none">{children}</span>;
}

function Tab({ to, label, icon }) {
  return (
    <NavLink
      to={to}
      className={({ isActive }) =>
        [
          "flex flex-col items-center justify-center gap-1",
          "text-xs",
          isActive ? "text-white" : "text-white/60 hover:text-white/80",
        ].join(" ")
      }
      aria-label={label}
    >
      <Icon>{icon}</Icon>
      <span className="text-[11px]">{label}</span>
    </NavLink>
  );
}

export default function BottomNav({ onSOS }) {
  const { user } = useAuth();
  const loc = useLocation();
  const navigate = useNavigate();

  const avatar = useMemo(() => {
    const u = user || {};
    return u.avatarUrl || u.photoUrl || u.profilePic || "";
  }, [user]);

  // Hide bottom nav on auth pages
  if (loc.pathname === "/login" || loc.pathname === "/register") return null;

  return (
    <div className="fixed bottom-0 left-0 right-0 z-50">
      {/* subtle gradient fade */}
      <div className="pointer-events-none h-10 bg-gradient-to-t from-black/80 to-transparent" />
      <div className="mx-auto max-w-md px-4 pb-4">
        <div className="relative rounded-3xl border border-white/10 bg-black/70 backdrop-blur-xl shadow-2xl">
          {/* center SOS floating button */}
          <button
            type="button"
            onClick={onSOS}
            className={[
              "absolute left-1/2 top-0 -translate-x-1/2 -translate-y-1/2",
              "h-16 w-16 rounded-full",
              "bg-red-600 hover:bg-red-500 active:bg-red-700",
              "shadow-[0_12px_40px_rgba(239,68,68,0.35)]",
              "border border-white/10",
              "flex items-center justify-center",
              "text-white text-xl font-bold",
              "focus:outline-none focus:ring-4 focus:ring-red-500/30",
            ].join(" ")}
            aria-label="SOS"
            title="SOS"
          >
            SOS
          </button>

          <div className="grid grid-cols-5 items-center px-5 py-4">
            <Tab to="/" label="Home" icon="ðŸ " />
            <Tab to="/community" label="Community" icon="ðŸ’¬" />

            {/* spacer for center button */}
            <div />

            <Tab to="/risk" label="Risk" icon="ðŸ›¡ï¸" />

            <button
              type="button"
              onClick={() => navigate("/profile")}
              className="flex flex-col items-center justify-center gap-1 text-white/60 hover:text-white/80"
              aria-label="Profile"
              title="Profile"
            >
              {avatar ? (
                <img
                  src={avatar}
                  alt="Profile"
                  className="h-6 w-6 rounded-full object-cover ring-2 ring-white/10"
                  onError={(e) => {
                    e.currentTarget.style.display = "none";
                  }}
                />
              ) : (
                <Icon>ðŸ‘¤</Icon>
              )}
              <span className="text-[11px]">Profile</span>
            </button>
          </div>
        </div>

        <div className="pt-3 text-center text-[11px] text-white/40">
          Tip: Long-press SOS to confirm (coming next).
        </div>
      </div>
    </div>
  );
}
'@
WriteUtf8NoBom $bottomNavPath $bottomNav

# --- AppShell ---
$appShell = @'
import BottomNav from "./BottomNav";
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "../context/AuthContext";

export default function AppShell({ children }) {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [sending, setSending] = useState(false);

  async function handleSOS() {
    // This is UI-only. Wire to backend next phase.
    if (sending) return;
    setSending(true);
    try {
      // Optional: push user to SOS page if you have one
      // navigate("/");

      // Quick UX feedback
      alert("SOS pressed. Next: we wire it to backend + location + contacts.");
    } finally {
      setSending(false);
    }
  }

  return (
    <div className="min-h-screen bg-black text-white">
      {/* Top bar */}
      <header className="sticky top-0 z-40 border-b border-white/10 bg-black/70 backdrop-blur-xl">
        <div className="mx-auto flex max-w-md items-center justify-between px-4 py-3">
          <div className="flex items-center gap-2">
            <div className="h-8 w-8 rounded-2xl bg-white/[0.06] border border-white/10 flex items-center justify-center">
              <span className="text-sm font-bold">DC</span>
            </div>
            <div className="leading-tight">
              <div className="text-sm font-semibold">DC Emergency</div>
              <div className="text-[11px] text-white/50">
                South Africa â€¢ Safety & Wellness
              </div>
            </div>
          </div>

          <div className="flex items-center gap-2">
            <button
              type="button"
              onClick={() => navigate("/community")}
              className="rounded-xl border border-white/10 bg-white/[0.06] px-3 py-2 text-xs text-white/80 hover:text-white hover:bg-white/[0.09]"
            >
              Updates
            </button>
          </div>
        </div>
      </header>

      {/* Content */}
      <main className="mx-auto max-w-md px-4 pb-28 pt-4">
        {children}
      </main>

      {/* Bottom Nav + SOS */}
      <BottomNav onSOS={handleSOS} />
    </div>
  );
}
'@
WriteUtf8NoBom $appShellPath $appShell

Ok "Wrote: client/src/components/ui/GlowCard.jsx"
Ok "Wrote: client/src/components/BottomNav.jsx"
Ok "Wrote: client/src/components/AppShell.jsx"

Say ""
Say "NEXT:"
Say "1) cd client"
Say "2) npm run dev"
Say "3) Hard refresh: Ctrl+Shift+R"
Say ""
Warn "If profile image doesn't show, your user object needs an avatarUrl (we'll add it next)."
Ok "Phase A UI next step applied."
